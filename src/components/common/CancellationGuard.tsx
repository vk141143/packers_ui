import React, { useState } from 'react';
import { AlertTriangle, X, Shield } from 'lucide-react';\nimport { BookingStatus } from '../types/booking';\nimport { useJobPermissions } from '../hooks/useJobPermissions';\n\ninterface CancellationGuardProps {\n  bookingId: string;\n  status: BookingStatus;\n  userRole: string;\n  hasDepositPaid: boolean;\n  onCancel: () => void;\n  onClose: () => void;\n}\n\nconst CANCELLATION_POLICY = {\n  'quote-requested': { allowed: true, reason: 'Booking can be cancelled before quote approval' },\n  'quote-generated': { allowed: true, reason: 'Booking can be cancelled before quote approval' },\n  'pending-admin': { allowed: true, reason: 'Booking can be cancelled before quote approval' },\n  'admin-quoted': { allowed: true, reason: 'Booking can be cancelled before payment' },\n  'client-approved': { allowed: true, reason: 'Booking can be cancelled before payment' },\n  'payment-pending': { allowed: false, reason: 'Cancellation blocked - payment in progress' },\n  'booking-confirmed': { allowed: false, reason: 'Cancellation blocked - deposit paid' },\n  'crew-assigned': { allowed: false, reason: 'Cancellation blocked - deposit paid' },\n  'in-progress': { allowed: false, reason: 'Cancellation blocked - work in progress' },\n  'work-completed': { allowed: false, reason: 'Cancellation blocked - work completed' },\n  'admin-reviewed': { allowed: false, reason: 'Cancellation blocked - work completed' },\n  'final-payment-pending': { allowed: false, reason: 'Cancellation blocked - work completed' },\n  'completed': { allowed: false, reason: 'Cancellation blocked - booking completed' },\n  'cancelled': { allowed: false, reason: 'Booking already cancelled' }\n};\n\nexport const CancellationGuard: React.FC<CancellationGuardProps> = ({\n  bookingId,\n  status,\n  userRole,\n  hasDepositPaid,\n  onCancel,\n  onClose\n}) => {\n  const [confirmationText, setConfirmationText] = useState('');\n  const permissions = useJobPermissions(status, userRole as any, hasDepositPaid);\n  const policy = CANCELLATION_POLICY[status];\n\n  // CRITICAL: Block all cancellation after deposit paid\n  const canCancel = permissions.canCancel && !hasDepositPaid;\n  const requiredText = 'CANCEL BOOKING';\n\n  if (!canCancel) {\n    return (\n      <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n        <div className=\"bg-white rounded-lg p-6 max-w-md w-full mx-4\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <Shield className=\"text-red-600\" size={24} />\n            <h3 className=\"text-lg font-semibold text-red-800\">Cancellation Not Allowed</h3>\n          </div>\n\n          <div className=\"bg-red-50 border border-red-200 rounded-lg p-4 mb-4\">\n            <div className=\"flex items-start gap-3\">\n              <AlertTriangle className=\"text-red-600 mt-0.5\" size={20} />\n              <div>\n                <p className=\"text-red-800 font-medium mb-1\">Policy Violation</p>\n                <p className=\"text-red-700 text-sm\">\n                  {hasDepositPaid \n                    ? 'This booking cannot be cancelled as the deposit has been paid. All bookings become non-cancellable and non-refundable after payment confirmation.'\n                    : policy.reason\n                  }\n                </p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-gray-50 p-3 rounded-lg mb-4\">\n            <p className=\"text-sm text-gray-600\">\n              <strong>Booking Reference:</strong> {bookingId}\n            </p>\n            <p className=\"text-sm text-gray-600\">\n              <strong>Current Status:</strong> {status.replace('-', ' ').toUpperCase()}\n            </p>\n          </div>\n\n          <div className=\"flex justify-end\">\n            <button\n              onClick={onClose}\n              className=\"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors\"\n            >\n              Close\n            </button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const handleCancel = () => {\n    if (confirmationText !== requiredText) {\n      alert(`Please type \"${requiredText}\" exactly to confirm cancellation.`);\n      return;\n    }\n    onCancel();\n  };\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n      <div className=\"bg-white rounded-lg p-6 max-w-md w-full mx-4\">\n        <div className=\"flex items-center gap-3 mb-4\">\n          <AlertTriangle className=\"text-yellow-600\" size={24} />\n          <h3 className=\"text-lg font-semibold text-gray-800\">Confirm Cancellation</h3>\n        </div>\n\n        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4\">\n          <p className=\"text-yellow-800 font-medium mb-2\">Warning</p>\n          <p className=\"text-yellow-700 text-sm\">\n            You are about to cancel this booking. This action cannot be undone.\n            {status === 'client-approved' && ' Once payment is made, cancellation will no longer be possible.'}\n          </p>\n        </div>\n\n        <div className=\"bg-gray-50 p-3 rounded-lg mb-4\">\n          <p className=\"text-sm text-gray-600\">\n            <strong>Booking Reference:</strong> {bookingId}\n          </p>\n          <p className=\"text-sm text-gray-600\">\n            <strong>Current Status:</strong> {status.replace('-', ' ').toUpperCase()}\n          </p>\n        </div>\n\n        <div className=\"mb-4\">\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n            Type \"{requiredText}\" to confirm cancellation:\n          </label>\n          <input\n            type=\"text\"\n            value={confirmationText}\n            onChange={(e) => setConfirmationText(e.target.value)}\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500\"\n            placeholder={requiredText}\n          />\n        </div>\n\n        <div className=\"flex gap-3\">\n          <button\n            onClick={onClose}\n            className=\"flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors\"\n          >\n            Keep Booking\n          </button>\n          <button\n            onClick={handleCancel}\n            disabled={confirmationText !== requiredText}\n            className={`flex-1 px-4 py-2 rounded-lg transition-colors ${\n              confirmationText === requiredText\n                ? 'bg-red-600 text-white hover:bg-red-700'\n                : 'bg-gray-300 text-gray-500 cursor-not-allowed'\n            }`}\n          >\n            Cancel Booking\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\n// Utility hook for cancellation button visibility\nexport const useCancellationPolicy = (status: BookingStatus, hasDepositPaid: boolean) => {\n  const policy = CANCELLATION_POLICY[status];\n  \n  return {\n    canCancel: policy.allowed && !hasDepositPaid,\n    reason: hasDepositPaid ? 'Cancellation blocked - deposit paid' : policy.reason,\n    showCancelButton: policy.allowed && !hasDepositPaid\n  };\n};